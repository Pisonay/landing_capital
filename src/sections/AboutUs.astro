---
import { ChevronLeft, ChevronRight } from "lucide-react";

const sliderImages = [
  {
    id: 1,
    title: "inmobiliaria",
    parrafo:
      "Pisonay inmobiliaria, con más de 15 años de experiencia, construyendo hogares seguros y modernos con un toque de diseño exquisito.",
    proyects: [
      {
        id: 1,
        image: "/images/pisonay/altara.webp",
        name: "altara",
        site: "San Borja",
      },
      {
        id: 2,
        image: "/images/pisonay/alzadia.webp",
        name: "alzadia",
        site: "Miraflores",
      },
      {
        id: 3,
        image: "/images/pisonay/constancia.webp",
        name: "constancia",
        site: "Wanchaq",
      },
      {
        id: 4,
        image: "/images/pisonay/el_senorial.webp",
        name: "el señorial",
        site: "Cayma",
      },
      {
        id: 5,
        image: "/images/pisonay/independent.webp",
        name: "Independent",
        site: "Surquillo",
      },
      {
        id: 6,
        image: "/images/pisonay/live_now.webp",
        name: "live now",
        site: "Surquillo lima",
      },
    ],
  },
  {
    id: 2,
    title: "civil y urbana",
    parrafo:
      "A lo largo de nuestra experiencia hemos realizado una gran cantidad de obras civiles construcciones urbanas y para el estado",
    proyects: [
      {
        id: 1,
        image: "/images/pisonay/obra1.webp",
        name: "Laboratorio Quimico",
        site: "Chorrillos",
      },
      {
        id: 2,
        image: "/images/pisonay/obra2.webp",
        name: "Parque Gorriti",
        site: "Lima",
      },
      {
        id: 3,
        image: "/images/pisonay/obra3.webp",
        name: "I.E Jose Olaya",
        site: "Ancash",
      },
      {
        id: 4,
        image: "/images/pisonay/obra4.webp",
        name: "Limpieza de Mallas",
        site: "Chosica",
      },
      {
        id: 5,
        image: "/images/pisonay/obra5.webp",
        name: "Descolmatacion de quebradas",
        site: "Cusco",
      },
      {
        id: 6,
        image: "/images/pisonay/obra6.webp",
        name: "I.E N89001",
        site: "Ancash",
      },
    ],
  },
];
---

<section id="aboutus" 
  class="py-12 md:py-20 lg:py-24 bg-gradient-to-br from-slate-50 via-gray-50 to-slate-100"
>
  <div class="max-w-[1600px] mx-auto px-4 sm:px-6 lg:px-8">
    <div class="space-y-32 lg:space-y-32">
      {
        sliderImages.map((section) => (
          <div class="overflow-hidden">
            {/* Header */}
            <div class="mb-12 lg:mb-16 text-center">
              <div class="inline-block mb-4">
                <h2 class="text-xs sm:text-sm font-bold tracking-[0.25em] text-gray-500 uppercase bg-gradient-to-r from-teal-100 to-cyan-100 px-5 py-2.5 rounded-full shadow-sm">
                  Conoce Nuestra Experiencia
                </h2>
              </div>
              <h3 class="text-4xl sm:text-5xl lg:text-6xl xl:text-7xl font-extrabold bg-gradient-to-r from-teal-600 via-teal-500 to-cyan-600 bg-clip-text text-transparent uppercase tracking-tight mb-6">
                {section.title}
              </h3>
              <p class="text-base sm:text-lg lg:text-xl text-gray-600 max-w-3xl mx-auto leading-relaxed font-medium">
                {section.parrafo}
              </p>
            </div>

            {/* Slider Container */}
            <div class="relative">
              {/* Previous Button */}
              <button
                class="slider-btn-prev absolute left-4 sm:left-6 lg:left-1 top-1/2 -translate-y-1/2 z-30 backdrop-blur-xl bg-white/95 hover:bg-primary-green text-teal-600 hover:text-white w-12 h-12 sm:w-14 sm:h-14 lg:w-16 lg:h-16 rounded-full shadow-xl hover:shadow-2xl transition-all duration-300 flex items-center justify-center group/btn hover:scale-110 active:scale-95 border border-gray-200/50 hover:border-transparent"
                data-section={section.id}
                aria-label="Anterior"
              >
                <ChevronLeft className="w-5 h-5 sm:w-6 sm:h-6 lg:w-8 lg:h-8 stroke-[2.5]" />
              </button>

              {/* Slider Wrapper */}
              <div class="overflow-hidden">
                <div
                  class="slider-track flex transition-transform duration-700 ease-out gap-4 sm:gap-6 lg:gap-8 px-4 sm:px-6 lg:px-8"
                  data-section={section.id}
                >
                  {section.proyects.map((project, idx) => (
                    <div class="slider-item flex-shrink-0 w-full sm:w-[calc(50%-12px)] lg:w-[calc(33.333%-21.333px)] xl:w-[calc(25%-24px)]">
                      <div
                        class="group/card h-full cursor-pointer"
                        data-project-id={`${section.id}-${idx}`}
                      >
                        <div class="relative overflow-hidden rounded-3xl shadow-xl hover:shadow-2xl transition-all duration-500 aspect-[3/4] bg-gradient-to-br from-gray-900 to-gray-800">
                          {/* Image */}
                          <img
                            src={project.image}
                            alt={project.name}
                            class="project-image w-full h-full object-cover transform group-hover/card:scale-105 transition-transform duration-700"
                            loading="lazy"
                            data-project-id={`${section.id}-${idx}`}
                          />

                          {/* Overlay */}
                          <div class="absolute inset-0 bg-linear-to-t from-black/90 via-black/40 to-transparent opacity-100 group-hover/card:opacity-90 transition-opacity duration-300">
                            <div class="absolute bottom-0 left-0 right-0 p-6 sm:p-7 lg:p-8">
                              <div class="space-y-3">
                                <h4 class="text-2xl sm:text-3xl lg:text-2xl font-black text-white uppercase tracking-wide leading-tight drop-shadow-2xl">
                                  {project.name}
                                </h4>
                                <div class="flex items-center gap-2 text-white/90">
                                  <div class="p-1.5 rounded-full bg-white/20 backdrop-blur-sm">
                                    <svg
                                      class="w-3.5 h-3.5 sm:w-4 sm:h-4"
                                      fill="none"
                                      stroke="currentColor"
                                      viewBox="0 0 24 24"
                                    >
                                      <path
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        stroke-width="2.5"
                                        d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"
                                      />
                                      <path
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        stroke-width="2.5"
                                        d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"
                                      />
                                    </svg>
                                  </div>
                                  <span class="text-sm sm:text-base font-bold tracking-wide">
                                    {project.site}
                                  </span>
                                </div>
                                <div class="pt-2 opacity-0 group-hover/card:opacity-100 transition-opacity duration-300">
                                  <div class="inline-flex items-center gap-2 text-white/80 text-sm font-semibold">
                                    <span>Ver proyecto</span>
                                    <svg
                                      class="w-4 h-4"
                                      fill="none"
                                      stroke="currentColor"
                                      viewBox="0 0 24 24"
                                    >
                                      <path
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        stroke-width="2"
                                        d="M9 5l7 7-7 7"
                                      />
                                    </svg>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>

                          {/* Hover Border Effect */}
                          <div class="absolute inset-0 border-4 border-teal-500/0 group-hover/card:border-teal-500/50 rounded-3xl transition-all duration-500 pointer-events-none" />
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              </div>

              {/* Next Button */}
              <button
                class="slider-btn-next absolute right-4 sm:right-6 lg:right-2 top-1/2 -translate-y-1/2 z-30 backdrop-blur-xl bg-white/95 hover:bg-primary-green text-teal-600 hover:text-white w-12 h-12 sm:w-14 sm:h-14 lg:w-16 lg:h-16 rounded-full shadow-xl hover:shadow-2xl transition-all duration-300 flex items-center justify-center group/btn hover:scale-110 active:scale-95 border border-gray-200/50 hover:border-transparent"
                data-section={section.id}
                aria-label="Siguiente"
              >
                <ChevronRight className="w-5 h-5 sm:w-6 sm:h-6 lg:w-8 lg:h-8 stroke-[2.5]" />
              </button>
            </div>

            {/* Indicators - iOS Style */}
            <div class="flex justify-center items-center gap-1.5 sm:gap-2 mt-8 sm:mt-10 lg:mt-12">
              {section.proyects.map((_, index) => (
                <button
                  class={`indicator transition-all duration-500 ease-out rounded-full ${
                    index === 0
                      ? "w-8 sm:w-10 h-2 sm:h-2.5 bg-teal-600 shadow-md"
                      : "w-2 sm:w-2.5 h-2 sm:h-2.5 bg-gray-400 hover:bg-gray-500"
                  }`}
                  data-section={section.id}
                  data-index={index}
                  aria-label={`Ir a proyecto ${index + 1}`}
                />
              ))}
            </div>
          </div>
        ))
      }
    </div>
  </div>

  {/* Modal for fullscreen image view */}
  <div
    id="imageModal"
    class="fixed inset-0 bg-black/95 backdrop-blur-sm z-[9999] hidden opacity-0 transition-opacity duration-300"
  >
    {/* Previous button */}
    <button
      id="modalPrev"
      class="absolute left-4 sm:left-6 lg:left-8 top-1/2 -translate-y-1/2 z-[10000] w-12 h-12 sm:w-14 sm:h-14 lg:w-16 lg:h-16 rounded-full bg-white/10 hover:bg-white/20 backdrop-blur-md text-white flex items-center justify-center transition-all duration-300 hover:scale-110 active:scale-95 border border-white/20 cursor-pointer"
      aria-label="Anterior"
      type="button"
    >
     <ChevronLeft className="w-6 h-6 sm:w-7 sm:h-7 lg:w-8 lg:h-8 pointer-events-none" /> 
    </button>

    {/* Next button */}
    <button
      id="modalNext"
      class="absolute right-4 sm:right-6 lg:right-8 top-1/2 -translate-y-1/2 z-[10000] w-12 h-12 sm:w-14 sm:h-14 lg:w-16 lg:h-16 rounded-full bg-white/10 hover:bg-white/20 backdrop-blur-md text-white flex items-center justify-center transition-all duration-300 hover:scale-110 active:scale-95 border border-white/20 cursor-pointer"
      aria-label="Siguiente"
      type="button"
    >
      <svg
        class="w-6 h-6 sm:w-7 sm:h-7 lg:w-8 lg:h-8 pointer-events-none"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
        stroke-width="2.5"
      >
        <polyline points="9 18 15 12 9 6"></polyline>
      </svg>
    </button>

    {/* Modal Content */}
    <div
      id="modalBackground"
      class="flex items-center justify-center h-full p-4 sm:p-6 lg:p-8"
    >
      <div
        class="relative max-w-7xl w-full h-full flex flex-col items-center justify-center pointer-events-none"
      >
        <img
          id="modalImage"
          src=""
          alt=""
          class="max-w-full max-h-full object-contain rounded-2xl shadow-2xl transition-opacity duration-300"
        />
        <div class="absolute bottom-0 left-0 right-0 text-center pb-6 sm:pb-8">
          <div
            class="inline-block bg-black/50 backdrop-blur-md rounded-2xl px-6 py-4 sm:px-8 sm:py-5"
          >
            <h3
              id="modalTitle"
              class="text-2xl sm:text-3xl lg:text-4xl font-bold text-white uppercase tracking-wide mb-2"
            >
            </h3>
            <p
              id="modalLocation"
              class="text-base sm:text-lg text-gray-200 font-medium"
            >
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
  interface Project {
    id: number;
    image: string;
    name: string;
    site: string;
  }

  class ProjectSlider {
    sectionId: number;
    currentIndex: number;
    track: HTMLElement;
    items: NodeListOf<Element>;
    indicators: NodeListOf<Element>;
    prevBtn: Element | null;
    nextBtn: Element | null;
    itemsPerView: number = 1;
    autoplayInterval: number | null = null;
    projects: Project[] = [];
    totalProjects: number = 0;

    constructor(sectionId: number, projects: Project[]) {
      this.sectionId = sectionId;
      this.projects = projects;
      this.totalProjects = projects.length;
      this.currentIndex = 0;
      this.track = document.querySelector(
        `.slider-track[data-section="${sectionId}"]`
      ) as HTMLElement;
      this.items = this.track?.querySelectorAll(".slider-item") || [];
      this.indicators = document.querySelectorAll(
        `.indicator[data-section="${sectionId}"]`
      );
      this.prevBtn = document.querySelector(
        `.slider-btn-prev[data-section="${sectionId}"]`
      );
      this.nextBtn = document.querySelector(
        `.slider-btn-next[data-section="${sectionId}"]`
      );

      this.init();
    }

    init() {
      this.updateItemsPerView();
      this.updateSlider();
      this.attachEvents();
      this.startAutoplay();

      window.addEventListener("resize", () => {
        this.updateItemsPerView();
        this.updateSlider();
      });
    }

    updateItemsPerView() {
      const width = window.innerWidth;
      if (width >= 1280) {
        this.itemsPerView = 4;
      } else if (width >= 1024) {
        this.itemsPerView = 3;
      } else if (width >= 640) {
        this.itemsPerView = 2;
      } else {
        this.itemsPerView = 1;
      }
    }

    updateSlider() {
      const totalGroups = Math.ceil(this.totalProjects / this.itemsPerView);
      
      if (this.currentIndex >= totalGroups) {
        this.currentIndex = 0;
      }

      const gap =
        window.innerWidth >= 1024 ? 32 : window.innerWidth >= 640 ? 24 : 16;
      const itemWidth = this.items[0]?.clientWidth || 0;
      const offset = this.currentIndex * (itemWidth + gap) * this.itemsPerView;

      if (this.track) {
        this.track.style.transform = `translateX(-${offset}px)`;
      }

      this.updateIndicators();
    }

    updateIndicators() {
      const totalGroups = Math.ceil(this.totalProjects / this.itemsPerView);

      this.indicators.forEach((indicator, index) => {
        if (index >= totalGroups) {
          (indicator as HTMLElement).style.display = "none";
        } else {
          (indicator as HTMLElement).style.display = "block";

          if (index === this.currentIndex) {
            indicator.classList.remove(
              "w-2",
              "sm:w-2.5",
              "bg-gray-400",
              "hover:bg-gray-500"
            );
            indicator.classList.add(
              "w-8",
              "sm:w-10",
              "bg-teal-600",
              "shadow-md"
            );
          } else {
            indicator.classList.remove(
              "w-8",
              "sm:w-10",
              "bg-teal-600",
              "shadow-md"
            );
            indicator.classList.add(
              "w-2",
              "sm:w-2.5",
              "bg-gray-400",
              "hover:bg-gray-500"
            );
          }
        }
      });
    }

    next() {
      const totalGroups = Math.ceil(this.totalProjects / this.itemsPerView);
      if (this.currentIndex < totalGroups - 1) {
        this.currentIndex++;
      } else {
        this.currentIndex = 0;
      }
      this.updateSlider();
      this.resetAutoplay();
    }

    prev() {
      const totalGroups = Math.ceil(this.totalProjects / this.itemsPerView);
      if (this.currentIndex > 0) {
        this.currentIndex--;
      } else {
        this.currentIndex = totalGroups - 1;
      }
      this.updateSlider();
      this.resetAutoplay();
    }

    goToSlide(index: number) {
      const totalGroups = Math.ceil(this.totalProjects / this.itemsPerView);
      if (index < totalGroups) {
        this.currentIndex = index;
        this.updateSlider();
        this.resetAutoplay();
      }
    }

    startAutoplay() {
      this.autoplayInterval = window.setInterval(() => {
        this.next();
      }, 5000);
    }

    stopAutoplay() {
      if (this.autoplayInterval) {
        clearInterval(this.autoplayInterval);
        this.autoplayInterval = null;
      }
    }

    resetAutoplay() {
      this.stopAutoplay();
      this.startAutoplay();
    }

    attachEvents() {
      this.prevBtn?.addEventListener("click", () => this.prev());
      this.nextBtn?.addEventListener("click", () => this.next());

      this.indicators.forEach((indicator, index) => {
        indicator.addEventListener("click", () => this.goToSlide(index));
      });

      this.track?.addEventListener("mouseenter", () => this.stopAutoplay());
      this.track?.addEventListener("mouseleave", () => this.startAutoplay());

      this.items.forEach((item, index) => {
        item.addEventListener("click", () => {
          openModal(this.sectionId, index, this.projects);
        });
      });
    }
  }

  let currentModalSection = 1;
  let currentModalIndex = 0;
  let modalProjects: Project[] = [];

  function openModal(
    sectionId: number,
    projectIndex: number,
    projects: Project[]
  ) {
    currentModalSection = sectionId;
    currentModalIndex = projectIndex;
    modalProjects = projects;

    const modal = document.getElementById("imageModal");
    const modalImage = document.getElementById("modalImage") as HTMLImageElement;
    const modalTitle = document.getElementById("modalTitle");
    const modalLocation = document.getElementById("modalLocation");

    const project = projects[projectIndex];

    if (modal && modalImage && modalTitle && modalLocation) {
      modalImage.src = project.image;
      modalImage.alt = project.name;
      modalTitle.textContent = project.name;
      modalLocation.textContent = project.site;

      modal.classList.remove("hidden");
      setTimeout(() => {
        modal.classList.remove("opacity-0");
      }, 10);

      document.body.style.overflow = "hidden";
    }
  }

  function closeModal() {
    const modal = document.getElementById("imageModal");
    if (modal) {
      modal.classList.add("opacity-0");
      setTimeout(() => {
        modal.classList.add("hidden");
        document.body.style.overflow = "";
      }, 300);
    }
  }

  function modalNext() {
    currentModalIndex = (currentModalIndex + 1) % modalProjects.length;
    updateModalContent();
  }

  function modalPrev() {
    currentModalIndex =
      (currentModalIndex - 1 + modalProjects.length) % modalProjects.length;
    updateModalContent();
  }

  function updateModalContent() {
    const modalImage = document.getElementById("modalImage") as HTMLImageElement;
    const modalTitle = document.getElementById("modalTitle");
    const modalLocation = document.getElementById("modalLocation");

    const project = modalProjects[currentModalIndex];

    if (modalImage && modalTitle && modalLocation) {
      modalImage.style.opacity = "0";
      setTimeout(() => {
        modalImage.src = project.image;
        modalImage.alt = project.name;
        modalTitle.textContent = project.name;
        modalLocation.textContent = project.site;
        modalImage.style.opacity = "1";
      }, 150);
    }
  }

  const sliderData = [
    {
      id: 1,
      projects: [
        {id: 1, image: "/images/pisonay/altara.webp", name: "altara", site: "San Borja"},
        {id: 2, image: "/images/pisonay/alzadia.webp", name: "alzadia", site: "Miraflores"},
        {id: 3, image: "/images/pisonay/constancia.webp", name: "constancia", site: "Wanchaq"},
        {id: 4, image: "/images/pisonay/el_senorial.webp", name: "el señorial", site: "Cayma"},
        {id: 5, image: "/images/pisonay/independent.webp", name: "Independent", site: "Surquillo"},
        {id: 6, image: "/images/pisonay/live_now.webp", name: "live now", site: "Surquillo lima"},
      ],
    },
    {
      id: 2,
      projects: [
        {id: 1, image: "/images/pisonay/obra1.webp", name: "Laboratorio Quimico", site: "Chorrillos"},
        {id: 2, image: "/images/pisonay/obra2.webp", name: "Parque Gorriti", site: "Lima"},
        {id: 3, image: "/images/pisonay/obra3.webp", name: "I.E Jose Olaya", site: "Ancash"},
        {id: 4, image: "/images/pisonay/obra4.webp", name: "Limpieza de Mallas", site: "Chosica"},
        {id: 5, image: "/images/pisonay/obra5.webp", name: "Descolmatacion de quebradas", site: "Cusco"},
        {id: 6, image: "/images/pisonay/obra6.webp", name: "I.E N89001", site: "Ancash"},
      ],
    },
  ];

  document.addEventListener("DOMContentLoaded", () => {
    sliderData.forEach((section) => {
      new ProjectSlider(section.id, section.projects);
    });

    const closeBtn = document.getElementById("closeModal");
    const modalNextBtn = document.getElementById("modalNext");
    const modalPrevBtn = document.getElementById("modalPrev");
    const modalBackground = document.getElementById("modalBackground");

    console.log("Elementos encontrados:", {
      closeBtn,
      modalNextBtn,
      modalPrevBtn,
      modalBackground
    });

    // if (closeBtn) {
    //   console.log("Agregando event listener al botón close");
      
    //   console.log(closeBtn);

    //   closeBtn.onclick = function(e) {
    //     console.log("CLOSE BUTTON CLICKED!");
    //     e.preventDefault();
    //     e.stopPropagation();
    //     closeModal();
    //   };
    // }

    if (modalNextBtn) {
      modalNextBtn.onclick = function(e) {
        console.log("NEXT BUTTON CLICKED!");
        e.preventDefault();
        e.stopPropagation();
        modalNext();
      };
    }

    if (modalPrevBtn) {
      modalPrevBtn.onclick = function(e) {
        console.log("PREV BUTTON CLICKED!");
        e.preventDefault();
        e.stopPropagation();
        modalPrev();
      };
    }

    if (modalBackground) {
      modalBackground.addEventListener("click", (e) => {
        if (e.target === modalBackground) {
          console.log("Background clicked!");
          closeModal();
        }
      });
    }

    document.addEventListener("keydown", (e) => {
      const modal = document.getElementById("imageModal");
      if (modal && !modal.classList.contains("hidden")) {
        if (e.key === "Escape") {
          closeModal();
        } else if (e.key === "ArrowLeft") {
          modalPrev();
        } else if (e.key === "ArrowRight") {
          modalNext();
        }
      }
    });
  });
</script>
